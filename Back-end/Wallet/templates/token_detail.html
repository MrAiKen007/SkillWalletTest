{% extends 'base.html' %}

{% block title %}Detalhes do Token{% endblock %}

{% block content %}
<div class="container">
  <h1 class="text-center">{{ token.name }} ({{ token.symbol }})</h1>

  <!-- Seção de Preço e Supply -->
  <div class="row">
    <div class="col-md-6">
      <h3>Preço Atual: <span id="tokenPrice">{{ token.price }} KZ</span></h3>
      <h4>Supply Total: <span id="tokenSupply">{{ token.supply }}</span> {{ token.symbol }}</h4>
    </div>
    <div class="col-md-6 text-end">
      <button class="btn btn-success" onclick="openTradeModal('buy')">Comprar</button>
      <button class="btn btn-danger" onclick="openTradeModal('sell')">Vender</button>
    </div>
  </div>

  <!-- Gráfico de Preço -->
  <div class="mt-4">
    <canvas id="priceChart"></canvas>
  </div>

  <!-- Livro de Ordens -->
  <div class="row mt-5">
    <div class="col-md-6">
      <h4>Ordens de Compra</h4>
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Quantidade</th>
            <th>Preço (KZ)</th>
          </tr>
        </thead>
        <tbody id="buyOrders">
          <tr><td colspan="2" class="text-center">Carregando...</td></tr>
        </tbody>
      </table>
    </div>
    <div class="col-md-6">
      <h4>Ordens de Venda</h4>
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Quantidade</th>
            <th>Preço (KZ)</th>
          </tr>
        </thead>
        <tbody id="sellOrders">
          <tr><td colspan="2" class="text-center">Carregando...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Histórico de Transações -->
  <div class="row mt-5">
    <h4>Histórico de Transações</h4>
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Data/Hora</th>
          <th>Tipo</th>
          <th>Quantidade</th>
          <th>Preço Unit.</th>
          <th>Total (KZ)</th>
        </tr>
      </thead>
      <tbody id="tradeHistory">
        <tr><td colspan="5" class="text-center">Carregando...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Modal para Compra e Venda -->
<div id="tradeModal" class="modal fade" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="tradeTitle"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="tradeForm">
          <input type="hidden" id="tradeType">
          <div class="mb-3">
            <label for="tradeQuantity" class="form-label">Quantidade:</label>
            <input type="number" id="tradeQuantity" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="tradePrice" class="form-label">Preço por Token (KZ):</label>
            <input type="number" id="tradePrice" class="form-control" required>
          </div>
          <button type="submit" class="btn btn-primary">Confirmar</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Obtém o tokenId a partir do contexto do template
const tokenId = "{{ token.id }}";
let priceChart = null;

// Função para obter o CSRF token
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== "") {
    const cookies = document.cookie.split(";");
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + "=")) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
const csrftoken = getCookie('csrftoken');

// Atualiza o preço e o supply do token com dados do back-end
async function updateTokenDetails() {
  try {
    const response = await fetch(`/api/tokens/${tokenId}/`, { credentials: "include" });
    if (!response.ok) throw new Error("Erro ao carregar detalhes do token.");
    const tokenData = await response.json();
    document.getElementById("tokenPrice").innerText = tokenData.price + " KZ";
    document.getElementById("tokenSupply").innerText = tokenData.supply;
  } catch (error) {
    console.error("Erro ao atualizar detalhes do token:", error);
  }
}

// Carrega o livro de ordens (compras e vendas)
async function loadOrderBook() {
  try {
    const response = await fetch(`/api/tokens/${tokenId}/orderbook/`, { credentials: "include" });
    if (!response.ok) throw new Error("Erro ao carregar o livro de ordens.");
    const data = await response.json();
    document.getElementById("buyOrders").innerHTML = data.buy.length
      ? data.buy.map(order => `
          <tr>
            <td>${order.quantity}</td>
            <td>${order.price} KZ</td>
          </tr>`).join("")
      : `<tr><td colspan="2" class="text-center">Sem ordens de compra</td></tr>`;
    document.getElementById("sellOrders").innerHTML = data.sell.length
      ? data.sell.map(order => `
          <tr>
            <td>${order.quantity}</td>
            <td>${order.price} KZ</td>
          </tr>`).join("")
      : `<tr><td colspan="2" class="text-center">Sem ordens de venda</td></tr>`;
  } catch (error) {
    console.error("Erro ao carregar o livro de ordens:", error);
  }
}

// Carrega ou atualiza os dados do gráfico de preços
async function loadChartData() {
  try {
    const response = await fetch(`/api/tokens/${tokenId}/chart/`, { credentials: "include" });
    if (!response.ok) throw new Error("Erro ao carregar os dados do gráfico.");
    const data = await response.json();
    const ctx = document.getElementById("priceChart").getContext("2d");
    if (priceChart) {
      priceChart.data.labels = data.timestamps;
      priceChart.data.datasets[0].data = data.prices;
      priceChart.update();
    } else {
      priceChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: data.timestamps,
          datasets: [{
            label: "Preço (KZ)",
            data: data.prices,
            borderColor: "blue",
            backgroundColor: "rgba(0, 0, 255, 0.2)",
            fill: true,
          }]
        }
      });
    }
  } catch (error) {
    console.error("Erro ao carregar o gráfico:", error);
  }
}

// Carrega o histórico de transações do token
async function loadTradeHistory() {
  try {
    const response = await fetch(`/api/tokens/${tokenId}/history/`, { credentials: "include" });
    if (!response.ok) throw new Error("Erro ao carregar o histórico de transações.");
    const trades = await response.json();
    const tbody = document.getElementById("tradeHistory");
    if (trades.length === 0) {
      tbody.innerHTML = `<tr><td colspan="5" class="text-center">Nenhuma transação encontrada.</td></tr>`;
    } else {
      tbody.innerHTML = trades.map(trade => {
        const total = (parseFloat(trade.price_per_unit) * parseFloat(trade.quantity)).toFixed(2);
        const dataHora = trade.created_at || "";
        return `
          <tr>
            <td>${dataHora}</td>
            <td>${trade.is_buy ? "Compra" : "Venda"}</td>
            <td>${trade.quantity}</td>
            <td>${trade.price_per_unit}</td>
            <td>${total}</td>
          </tr>
        `;
      }).join("");
    }
  } catch (error) {
    console.error("Erro ao carregar o histórico de transações:", error);
  }
}

// Abre o modal para realizar trade (compra/venda)
function openTradeModal(type) {
  document.getElementById("tradeType").value = type;
  document.getElementById("tradeTitle").innerText = type === "buy" ? "Comprar Tokens" : "Vender Tokens";
  new bootstrap.Modal(document.getElementById("tradeModal")).show();
}

// Envia a ordem de trade (compra ou venda)
document.getElementById("tradeForm").addEventListener("submit", async function(event) {
  event.preventDefault();
  const tradeType = document.getElementById("tradeType").value;
  const quantity = document.getElementById("tradeQuantity").value;
  const price = document.getElementById("tradePrice").value;
  try {
    const response = await fetch(`/api/tokens/${tokenId}/trade/`, {
      method: "POST",
      headers: { 
        "Content-Type": "application/json", 
        "X-CSRFToken": "{{ csrf_token }}",
      },
      body: JSON.stringify({ type: tradeType, quantity, price })
    });
    if (!response.ok) throw new Error("Erro ao enviar ordem.");
    alert("Ordem enviada com sucesso!");
    loadOrderBook();
    loadTradeHistory();
    updateTokenDetails();
    loadChartData();
  } catch (error) {
    console.error("Erro ao enviar ordem:", error);
    alert("Erro: " + error.message);
  }
});

// Atualiza periodicamente os dados dinâmicos
setInterval(updateTokenDetails, 30000);
setInterval(loadOrderBook, 30000);
setInterval(loadChartData, 30000);
setInterval(loadTradeHistory, 30000);

// Inicializa os dados quando a página é carregada
document.addEventListener("DOMContentLoaded", function() {
  updateTokenDetails();
  loadOrderBook();
  loadChartData();
  loadTradeHistory();
});
</script>
{% endblock %}
