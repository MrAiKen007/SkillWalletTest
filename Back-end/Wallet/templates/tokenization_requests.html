{% extends 'base.html' %}

{% block title %}Requisições de Tokenização{% endblock %}

{% block content %}
<div class="container">
    <h1>Requisições de Tokenização</h1>
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>ID</th>
                <th>Empresa (Usuário)</th>
                <th>Valuation (KZ)</th>
                <th>% Tokenizado</th>
                <th>Qtd. de Tokens</th>
                <th>Preço por Token (KZ)</th>
                <th>Nome do Token</th>
                <th>Símbolo</th>
                <th>Descrição</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody id="requestsTable">
            <tr>
                <td colspan="10" class="text-center">Carregando requisições...</td>
            </tr>
        </tbody>
    </table>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Função para obter o valor de um cookie (necessário para CSRF)
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + "=")) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

// Carrega as requisições de tokenização pendentes
async function loadRequests() {
    try {
        const response = await fetch("/api/tokenization/requests/", { credentials: "include" });
        if (!response.ok) throw new Error("Erro ao carregar requisições.");
        const requests = await response.json();
        const tbody = document.getElementById("requestsTable");
        if (requests.length === 0) {
            tbody.innerHTML = `<tr><td colspan="10" class="text-center">Nenhuma requisição pendente.</td></tr>`;
        } else {
            tbody.innerHTML = "";
            requests.forEach(req => {
                tbody.innerHTML += `
                    <tr>
                        <td>${req.id}</td>
                        <td>${req.user ? req.user.username : "N/A"}</td>
                        <td>${req.valuation}</td>
                        <td>${req.percentage}</td>
                        <td>${req.token_quantity}</td>
                        <td>${req.token_price}</td>
                        <td>${req.token_name}</td>
                        <td>${req.token_symbol}</td>
                        <td>${req.description || ""}</td>
                        <td>
                            <button onclick="approveRequest(${req.id})" class="btn btn-success btn-sm">Aprovar</button>
                            <button onclick="rejectRequest(${req.id})" class="btn btn-danger btn-sm">Rejeitar</button>
                        </td>
                    </tr>
                `;
            });
        }
    } catch (error) {
        console.error("Erro ao carregar requisições:", error);
    }
}

// Envia requisição para aprovar uma solicitação
async function approveRequest(requestId) {
    try {
        const response = await fetch("/api/tokenization/approve/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrftoken
            },
            credentials: "include",
            body: JSON.stringify({ request_id: requestId })
        });
        const result = await response.json();
        if (response.ok) {
            alert(result.message);
            loadRequests();
        } else {
            alert("Erro: " + JSON.stringify(result));
        }
    } catch (error) {
        console.error("Erro ao aprovar requisição:", error);
        alert("Erro de conexão: " + error);
    }
}

// Envia requisição para rejeitar uma solicitação
async function rejectRequest(requestId) {
    try {
        const response = await fetch("/api/tokenization/reject/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrftoken
            },
            credentials: "include",
            body: JSON.stringify({ request_id: requestId })
        });
        const result = await response.json();
        if (response.ok) {
            alert(result.message);
            loadRequests();
        } else {
            alert("Erro: " + JSON.stringify(result));
        }
    } catch (error) {
        console.error("Erro ao rejeitar requisição:", error);
        alert("Erro de conexão: " + error);
    }
}

document.addEventListener("DOMContentLoaded", function() {
    loadRequests();
});
</script>
{% endblock %}
