<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Minha Wallet</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 400px; }
        .balance { font-size: 20px; margin-top: 10px; }
        form { margin-top: 20px; border: 1px solid #ccc; padding: 10px; }
        form h2 { font-size: 18px; margin-bottom: 10px; }
        input { margin-bottom: 10px; padding: 5px; width: 100%; }
        button { padding: 10px 20px; cursor: pointer; }
        .message { margin-top: 10px; color: green; }
        .error { margin-top: 10px; color: red; }
        #receiveSection { margin-top: 20px; border: 1px solid #ccc; padding: 10px; }
        #dashboardButton { margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Minha Wallet</h1>
        <p><strong>Usuário:</strong> <span id="username">Carregando...</span></p>
        <p><strong>Saldo KZ:</strong> <span id="balanceKZ">0</span></p>
        <p><strong>Token KZ:</strong> <span id="tokenKZ">0</span></p>
        <p><strong>USD:</strong> <span id="usdPrice">Carregando...</span></p>
        <p><strong>TON:</strong> <span id="tonPrice">Carregando...</span></p>
        
        <!-- Botão para acessar o Dashboard de Investimento -->
        <div id="dashboardButton">
            <button type="button" onclick="goToInvestmentDashboard()">Ir para Dashboard de Investimento</button>
        </div>
        
        <!-- Formulário para Enviar Tokens -->
        <form id="sendForm">
            <h2>Enviar Tokens</h2>
            <label for="receiverEmail">E-mail do Destinatário:</label>
            <input type="email" id="receiverEmail" placeholder="destinatario@exemplo.com" required>
            <label for="sendAmount">Valor (KZ):</label>
            <input type="number" id="sendAmount" step="0.01" required>
            <button type="submit">Enviar</button>
            <div id="sendResult"></div>
        </form>

        <!-- Formulário para Depositar Tokens -->
        <form id="depositForm">
            <h2>Depositar Tokens</h2>
            <label for="depositAmount">Valor (KZ):</label>
            <input type="number" id="depositAmount" step="0.01" required>
            <button type="submit">Depositar</button>
            <div id="depositResult"></div>
        </form>
        
        <!-- Seção para Receber Tokens (exibe o e-mail do usuário) -->
        <div id="receiveSection">
            <h2>Receber Tokens</h2>
            <p>Seu endereço de recebimento: <span id="userEmail">Carregando...</span></p>
        </div>
    </div>

    <script>
        // Função para obter o valor de um cookie (necessário para CSRF)
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== "") {
                const cookies = document.cookie.split(";");
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + "=")) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        function goToInvestmentDashboard() {
            // Redireciona para o Dashboard de Investimento (ajuste a URL conforme necessário)
            window.location.href = "/investment/";
        }

        async function loadWallet() {
            const userData = JSON.parse(localStorage.getItem("userData"));
            if (!userData || !userData.username) {
                alert("Usuário não autenticado.");
                window.location.href = "login.html";
                return;
            }
            document.getElementById("username").innerText = userData.username;
            // Atualiza o endereço de recebimento (email do usuário)
            document.getElementById("userEmail").innerText = userData.email || "Não disponível";

            try {
                const response = await fetch("http://127.0.0.1:8000/api/wallet/balance/", {
                    credentials: "include"
                });
                if (!response.ok) throw new Error("Erro ao carregar wallet.");
                const wallet = await response.json();
                // Utilize o campo 'balance' conforme retornado pelo back-end
                document.getElementById("balanceKZ").innerText = wallet.balance || "0";
                document.getElementById("tokenKZ").innerText = wallet.token_kz || "0";
            } catch (error) {
                console.error("Erro ao carregar wallet:", error);
            }
        }

        async function updatePrices() {
            try {
                const responseUsd = await fetch("https://api.currencybeacon.com/v1/latest?base=USD&symbols=AOA&api_key=QQy7VbtncNg6EA07JqtgaYizyo50SmOG");
                const dataUsd = await responseUsd.json();
                const usdInAoa = dataUsd.data?.rates?.AOA ? Number(dataUsd.data.rates.AOA).toFixed(2) : "Indisponível";

                const responseTon = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=toncoin&vs_currencies=aoa");
                const dataTon = await responseTon.json();
                const tonInAoa = dataTon.toncoin?.aoa ? Number(dataTon.toncoin.aoa).toFixed(2) : "Indisponível";

                document.getElementById("usdPrice").innerText = `1 USD = ${usdInAoa} KZ`;
                document.getElementById("tonPrice").innerText = `1 TON = ${tonInAoa} KZ`;
            } catch (error) {
                console.error("Erro ao carregar preços:", error);
            }
        }

        async function sendTokens(e) {
            e.preventDefault();
            const receiverEmail = document.getElementById("receiverEmail").value.trim();
            const amount = parseFloat(document.getElementById("sendAmount").value);
            if (!receiverEmail || isNaN(amount) || amount <= 0) {
                document.getElementById("sendResult").innerHTML = `<p class="error">Dados inválidos.</p>`;
                return;
            }
            try {
                const response = await fetch("http://127.0.0.1:8000/api/wallet/send/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrftoken
                    },
                    credentials: "include",
                    body: JSON.stringify({ receiver_email: receiverEmail, amount })
                });
                const result = await response.json();
                if (response.ok) {
                    document.getElementById("sendResult").innerHTML = `<p class="message">${result.message}</p>`;
                    loadWallet();
                } else {
                    document.getElementById("sendResult").innerHTML = `<p class="error">${JSON.stringify(result)}</p>`;
                }
            } catch (error) {
                console.error("Erro ao enviar tokens:", error);
                document.getElementById("sendResult").innerHTML = `<p class="error">Erro de conexão: ${error}</p>`;
            }
        }

        async function depositTokens(e) {
            e.preventDefault();
            const amount = parseFloat(document.getElementById("depositAmount").value);
            if (isNaN(amount) || amount <= 0) {
                document.getElementById("depositResult").innerHTML = `<p class="error">Valor inválido.</p>`;
                return;
            }
            try {
                const response = await fetch("http://127.0.0.1:8000/api/wallet/deposit/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrftoken
                    },
                    credentials: "include",
                    body: JSON.stringify({ amount })
                });
                const result = await response.json();
                if (response.ok) {
                    document.getElementById("depositResult").innerHTML = `<p class="message">${result.message}</p>`;
                    loadWallet();
                } else {
                    document.getElementById("depositResult").innerHTML = `<p class="error">${JSON.stringify(result)}</p>`;
                }
            } catch (error) {
                console.error("Erro ao depositar tokens:", error);
                document.getElementById("depositResult").innerHTML = `<p class="error">Erro de conexão: ${error}</p>`;
            }
        }

        // Associa os formulários aos eventos
        document.getElementById("sendForm").addEventListener("submit", sendTokens);
        document.getElementById("depositForm").addEventListener("submit", depositTokens);

        loadWallet();
        updatePrices();
        setInterval(updatePrices, 30000);
    </script>
</body>
</html>
