{% extends 'base.html' %}

{% block title %}Dashboard de Investimento{% endblock %}

{% block content %}
<div class="container">
    <h1>Dashboard de Investimento</h1>
    
    <!-- Seção de Saldo -->
    <div class="card mb-4">
        <div class="card-body">
            <h4>Saldo da Conta de Investimento</h4>
            <p><strong>Saldo:</strong> <span id="investment_balance">Carregando...</span> KZ</p>
        </div>
    </div>
    
    <!-- Seção de Depósito e Saque -->
    <div class="card mb-4">
        <div class="card-body">
            <h4>Gerenciar Fundos</h4>
            <div class="row">
                <div class="col-md-6">
                    <form id="depositForm">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="depositAmount">Depositar (KZ):</label>
                            <input type="number" class="form-control" id="depositAmount" step="0.01" required>
                        </div>
                        <button type="submit" class="btn btn-success btn-block">Depositar</button>
                        <div id="depositResult"></div>
                    </form>
                </div>
                <div class="col-md-6">
                    <form id="withdrawForm">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="withdrawAmount">Sacar (KZ):</label>
                            <input type="number" class="form-control" id="withdrawAmount" step="0.01" required>
                        </div>
                        <button type="submit" class="btn btn-warning btn-block">Sacar</button>
                        <div id="withdrawResult"></div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Seção para Listar Tokens Disponíveis -->
    <div class="card mb-4">
        <div class="card-body">
            <h4>Tokens Listados para Investimento</h4>
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Token</th>
                        <th>Símbolo</th>
                        <th>Supply</th>
                        <th>Preço</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="tokensList">
                    <tr>
                        <td colspan="5" class="text-center">Carregando tokens...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Botão para ativar o modo tokenização (para todos os usuários) -->
    <div class="mb-4">
        <a href="/tokenization/configure/" class="btn btn-info btn-block">Ativar Modo Tokenização</a>
    </div>
    
    <!-- Botão para Gerenciar o Token (aparece se o token do usuário estiver criado) -->
    {% if user_token %}
    <div class="mb-4">
        <a href="{% url 'token_management' token_id=user_token.id %}" class="btn btn-primary btn-block">Gerenciar Meu Token</a>
    </div>
    {% endif %}
    
    <!-- Botão para voltar à Wallet Normal -->
    <div class="mb-4">
        <a href="/wallet/" class="btn btn-secondary btn-block">Voltar para Wallet Normal</a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Função para obter o valor de um cookie (necessário para CSRF)
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + "=")) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // Carregar o saldo de investimento
    async function loadInvestmentBalance() {
        try {
            const response = await fetch("/api/investment/balance/", { credentials: "include" });
            if (!response.ok) throw new Error("Erro ao carregar saldo de investimento.");
            const data = await response.json();
            document.getElementById("investment_balance").innerText = data.balance || "0";
        } catch (error) {
            console.error("Erro ao carregar saldo de investimento:", error);
        }
    }

    // Depositar na conta de investimento
    async function depositInvestment(e) {
        e.preventDefault();
        const amount = parseFloat(document.getElementById("depositAmount").value);
        if (isNaN(amount) || amount <= 0) {
            document.getElementById("depositResult").innerHTML = `<p class="error">Valor inválido.</p>`;
            return;
        }
        try {
            const response = await fetch("/api/investment/deposit/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrftoken
                },
                credentials: "include",
                body: JSON.stringify({ amount })
            });
            const result = await response.json();
            if (response.ok) {
                document.getElementById("depositResult").innerHTML = `<p class="message">${result.message}</p>`;
                loadInvestmentBalance();
            } else {
                document.getElementById("depositResult").innerHTML = `<p class="error">${JSON.stringify(result)}</p>`;
            }
        } catch (error) {
            console.error("Erro ao depositar fundos:", error);
            document.getElementById("depositResult").innerHTML = `<p class="error">Erro de conexão: ${error}</p>`;
        }
    }

    // Sacar da conta de investimento
    async function withdrawInvestment(e) {
        e.preventDefault();
        const amount = parseFloat(document.getElementById("withdrawAmount").value);
        if (isNaN(amount) || amount <= 0) {
            document.getElementById("withdrawResult").innerHTML = `<p class="error">Valor inválido.</p>`;
            return;
        }
        try {
            const response = await fetch("/api/investment/withdraw/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrftoken
                },
                credentials: "include",
                body: JSON.stringify({ amount })
            });
            const result = await response.json();
            if (response.ok) {
                document.getElementById("withdrawResult").innerHTML = `<p class="message">${result.message}</p>`;
                loadInvestmentBalance();
            } else {
                document.getElementById("withdrawResult").innerHTML = `<p class="error">${JSON.stringify(result)}</p>`;
            }
        } catch (error) {
            console.error("Erro ao sacar fundos:", error);
            document.getElementById("withdrawResult").innerHTML = `<p class="error">Erro de conexão: ${error}</p>`;
        }
    }

    // Carregar a lista de tokens disponíveis para investimento
    async function loadTokensList() {
        try {
            const response = await fetch("/api/tokens/list/", { credentials: "include" });
            if (!response.ok) throw new Error("Erro ao carregar tokens.");
            const tokens = await response.json();
            const tbody = document.getElementById("tokensList");
            if (tokens.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center">Nenhum token listado.</td></tr>`;
            } else {
                tbody.innerHTML = "";
                tokens.forEach(token => {
                    tbody.innerHTML += `<tr>
                        <td>${token.token_request.token_name}</td>
                        <td>${token.token_request.token_symbol}</td>
                        <td>${token.supply}</td>
                        <td>${token.price}</td>
                        <td>
                            <a href="token/${token.id}/" class="btn btn-info btn-sm">Detalhes</a>
                        </td>
                    </tr>`;
                });
            }
        } catch (error) {
            console.error("Erro ao carregar lista de tokens:", error);
        }
    }

    // Inicializa os dados e associa os eventos
    document.getElementById("depositForm").addEventListener("submit", depositInvestment);
    document.getElementById("withdrawForm").addEventListener("submit", withdrawInvestment);

    // Chamadas iniciais
    loadInvestmentBalance();
    loadTokensList();
    // Atualiza periodicamente (a cada 30 segundos)
    setInterval(loadTokensList, 30000);
    // Se você tiver uma função global updatePrices, pode chamá-la aqui:
    setInterval(updatePrices, 30000);
</script>
{% endblock %}
